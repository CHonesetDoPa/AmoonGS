<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmoonGS 控制面板</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    </style>
</head>
<body>
    <!-- 背景装饰 -->
    <div class="background-decoration"></div>

    <!-- 主容器 -->
    <div class="main-container">
        <!-- 头部 -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <i class="fas fa-rocket logo-icon"></i>
                    <h1 class="app-title">AmoonGS</h1>
                </div>
                <div class="status-badge" id="status-badge">
                    <i class="fas fa-circle status-icon"></i>
                    <span>就绪</span>
                </div>
            </div>
        </header>

        <!-- 控制面板 -->
        <div class="control-panel">
            <h2 class="section-title">
                <i class="fas fa-gamepad"></i>
                设备控制
            </h2>
            <div class="control-grid">
                <!-- 设备选择 -->
                <div class="device-selector">
                    <label for="device-select">选择设备：</label>
                    <select id="device-select" class="device-select" onchange="selectDeviceBySelect()">
                        <option value="">正在获取设备列表...</option>
                    </select>
                </div>

                <!-- Gnirehtet 控制区域 -->
                <div class="control-section">
                    <h3 class="section-subtitle">Gnirehtet 控制</h3>
                    <div class="control-buttons">
                        <button class="control-btn start-btn" onclick="executeScript('startGnirehtet')">
                            <div class="btn-icon">
                                <i class="fas fa-play"></i>
                            </div>
                            <div class="btn-content">
                                <span class="btn-title">启动 Gnirehtet</span>
                                <span class="btn-desc">启动 Gnirehtet 服务</span>
                            </div>
                        </button>
                        <button class="control-btn stop-btn" onclick="executeScript('stopGnirehtet')">
                            <div class="btn-icon">
                                <i class="fas fa-stop"></i>
                            </div>
                            <div class="btn-content">
                                <span class="btn-title">停止 Gnirehtet</span>
                                <span class="btn-desc">关闭 Gnirehtet 服务</span>
                            </div>
                        </button>
                        <button class="control-btn start-btn" onclick="executeScriptForSelectedDevice('startGnirehtetAndUnlock')">
                            <div class="btn-icon">
                                <i class="fas fa-play-circle"></i>
                            </div>
                            <div class="btn-content">
                                <span class="btn-title">启动并执行</span>
                                <span class="btn-desc">启动服务并执行脚本</span>
                            </div>
                        </button>
                        <button class="control-btn stop-btn" onclick="executeScriptForSelectedDevice('stopGnirehtetAndLock')">
                            <div class="btn-icon">
                                <i class="fas fa-stop-circle"></i>
                            </div>
                            <div class="btn-content">
                                <span class="btn-title">停止并关闭</span>
                                <span class="btn-desc">停止服务并关闭屏幕</span>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- ADB 控制区域 -->
                <div class="control-section">
                    <h3 class="section-subtitle">ADB 控制</h3>
                    <div class="control-buttons">
                        <button class="control-btn unlock-btn" onclick="executeScriptForSelectedDevice('unlockDevice')">
                            <div class="btn-icon"><i class="fas fa-unlock"></i></div>
                            <div class="btn-content">
                                <span class="btn-title">解锁设备</span>
                                <span class="btn-desc">发送解锁按键事件</span>
                            </div>
                        </button>

                        <button class="control-btn lock-btn" onclick="executeScriptForSelectedDevice('lockDevice')">
                            <div class="btn-icon"><i class="fas fa-lock"></i></div>
                            <div class="btn-content">
                                <span class="btn-title">锁屏设备</span>
                                <span class="btn-desc">发送电源按键事件</span>
                            </div>
                        </button>

                        <button class="control-btn info-btn" onclick="showDeviceInfo()">
                            <div class="btn-icon"><i class="fas fa-info-circle"></i></div>
                            <div class="btn-content">
                                <span class="btn-title">设备信息</span>
                                <span class="btn-desc">查看设备 ID 与状态</span>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 日志区域 -->
        <div class="logs-section">
            <div class="log-panel">
                <div class="log-header">
                    <h3 class="log-title">
                        <i class="fas fa-network-wired"></i>
                        Gnirehtet 日志
                    </h3>
                    <button class="clear-btn" onclick="clearLog('gnirehtet-log-output')">
                        <i class="fas fa-broom"></i>
                    </button>
                </div>
                <div class="log-content" id="gnirehtet-log-output">
                    <div class="log-placeholder">
                        <i class="fas fa-terminal"></i>
                        <p>等待日志输出...</p>
                    </div>
                </div>
            </div>

            <div class="log-panel">
                <div class="log-header">
                    <h3 class="log-title">
                        <i class="fas fa-mobile-alt"></i>
                        ADB 日志
                    </h3>
                    <button class="clear-btn" onclick="clearLog('log-output')">
                        <i class="fas fa-broom"></i>
                    </button>
                </div>
                <div class="log-content" id="log-output">
                    <div class="log-placeholder">
                        <i class="fas fa-terminal"></i>
                        <p>等待日志输出...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 错误框 -->
        <div id="error-box" class="error-box hidden">
            <div class="error-content">
                <span id="error-message">发生错误</span>
                <button class="close-btn" onclick="hideErrorBox()">关闭</button>
            </div>
        </div>

        <!-- 页脚 -->
        <footer class="footer">
            <p>
                <i class="fas fa-code"></i>
                Made with <i class="fas fa-heart"></i> by CH
            </p>
        </footer>
    </div>

    <script src="assets/js/renderer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script>
        async function executeScript(scriptName, deviceId = null) {
            const statusBadge = document.getElementById('status-badge');
            statusBadge.innerHTML = '<i class="fas fa-circle status-icon running"></i><span>运行中</span>';
            
            try {
                const response = await fetch('scripts/script.yaml');
                if (!response.ok) {
                    throw new Error(`无法加载脚本文件 (HTTP ${response.status})`);
                }
                const yamlText = await response.text();
                const scripts = jsyaml.load(yamlText) || {};
                const script = scripts[scriptName];

                if (!Array.isArray(script)) {
                    throw new Error(`未找到脚本 "${scriptName}"`);
                }

                for (const step of script) {
                    let command = step.command;
                    if (deviceId && command.includes('{deviceId}')) {
                        command = command.replace(/\{deviceId\}/g, deviceId);
                    }
                    await sendCommandWithDelay(command, step.delay);
                }
                
                statusBadge.innerHTML = '<i class="fas fa-circle status-icon"></i><span>就绪</span>';
            } catch (error) {
                statusBadge.innerHTML = '<i class="fas fa-circle status-icon error"></i><span>错误</span>';
                console.error('Script execution failed:', error);
                showErrorMessage(`脚本执行失败：${error.message || error}`);
            }
        }

        function sendCommandWithDelay(command, delay) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    if (command === 'exitApp') {
                        window.api.exitApp();
                    } else {
                        sendCommand(command);
                    }
                    resolve();
                }, delay);
            });
        }

        function executeScriptForSelectedDevice(scriptName) {
            const device = window._selectedDevice;
            if (!device) {
                showErrorMessage('请先选择设备');
                return;
            }
            executeScript(scriptName, device.id);
        }

        function showErrorMessage(message) {
            const errorBox = document.getElementById('error-box');
            errorBox.classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }

        document.addEventListener('DOMContentLoaded', () => {
            getAdbDevices();
        });
    </script>
</body>
</html>
